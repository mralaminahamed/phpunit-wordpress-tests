name: Update from WordPress Develop Repository

on:
  push:
    branches:
      - development # Adjust the branch name as needed
  schedule:
    - cron: '0 * * * *'

jobs:
  update-source-code-and-create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git user
        run: |
          git config user.name 'github-actions'
          git config user.email 'github-actions@github.com'

      - name: Create and switch to new branch
        run: git checkout -b "update/sync-from-wordpress-develop-repo"

      - name: Clone the WordPress Develop repository
        run: git clone git://develop.git.wordpress.org/ source --quiet

      - name: Copy the necessary files to the root directory
        run: |
          cp -r source/tests/phpunit/data/* data
          cp -r source/tests/phpunit/includes/* includes
          cp -r source/tests/phpunit/multisite.xml multisite.xml
          cp -r source/tests/phpunit/wp-mail-real-test.php wp-mail-real-test.php
          cp -r source/wp-tests-config-sample.php wp-config-sample.php

      - name: Remove the source directory
        run: rm -rf "source"

      - name: Commit the changes
        run: |
          git add .
          git commit -m "Update from WordPress Develop"

      - name: Get the current branch name
        id: branch_name
        run: echo "branch_name=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT

      - name: Push the changes to the remote repository
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} ${{ steps.branch_name.outputs.branch_name }}

      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh

      - name: Authenticate with GitHub CLI
        run: gh auth login --with-token <<< ${{ secrets.GITHUB_TOKEN }}

      - name: Create a pull request
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: gh pr create --base main --head "$branch_name" --title "Update from WordPress Develop" --body "This PR updates the codebase with the latest changes from the WordPress Develop repository"

      - name: Check Output
        run: |
          echo "Pull Request created successfully!"
